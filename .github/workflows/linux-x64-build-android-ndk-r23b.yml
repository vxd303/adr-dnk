name: linux-x64-build-android-ndk-r23 (libamice.so via clang-r416183b1)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      AMICE_DIR: ${{ github.workspace }}/amice
      OUT_DIR: ${{ github.workspace }}/out
      CLANG_DIR: ${{ github.workspace }}/clang-r416183b1
      # Clang unstripped bạn yêu cầu (LLVM 12, r416183b1)
      CLANG_UNSTRIPPED_URL: https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/219e6aaa8fecc0ab0df4e691a9645ba778267af2/clang-r416183b1.tar.gz

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4

      - name: Checkout amice source
        uses: actions/checkout@v4
        with:
          repository: fuqiuluo/amice
          ref: master
          path: amice

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo (amice)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.AMICE_DIR }}/target
          key: ${{ runner.os }}-cargo-amice-${{ hashFiles('amice/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-amice-

      - name: Prepare folders
        run: |
          set -eux
          mkdir -p "$OUT_DIR" "$CLANG_DIR"

      - name: Download unstripped Clang r416183b1 (LLVM 12)
        run: |
          set -eux
          curl -fL "$CLANG_UNSTRIPPED_URL" -o /tmp/clang-r416183b1.tar.gz
          tar -xzf /tmp/clang-r416183b1.tar.gz -C "$CLANG_DIR"
          "$CLANG_DIR/bin/clang++" --version || true
          ls -l "$CLANG_DIR/lib"  || true
          ls -l "$CLANG_DIR/lib64"|| true

      - name: Normalize LLVM dylib name (create libLLVM.so → libLLVM-12.so)
        run: |
          set -eux
          LIBDIR=""
          if [ -f "$CLANG_DIR/lib/libLLVM-12.so" ]; then
            LIBDIR="$CLANG_DIR/lib"
          elif [ -f "$CLANG_DIR/lib64/libLLVM-12.so" ]; then
            LIBDIR="$CLANG_DIR/lib64"
          else
            echo "libLLVM-12.so not found under $CLANG_DIR/{lib,lib64}"; exit 1
          fi
          ln -sf "$LIBDIR/libLLVM-12.so" "$LIBDIR/libLLVM.so"
          echo "Using LIBDIR=$LIBDIR"
          ls -l "$LIBDIR/libLLVM-12.so" "$LIBDIR/libLLVM.so"

          # Export paths so linker & runtime tìm đúng
          echo "LLVM_SYS_120_PREFIX=$CLANG_DIR" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$LIBDIR:${LD_LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$LIBDIR:${LIBRARY_PATH:-}" >> $GITHUB_ENV
          echo "CXX=$CLANG_DIR/bin/clang++" >> $GITHUB_ENV
          echo "CXXFLAGS=-DLLVM_VERSION_MAJOR=12" >> $GITHUB_ENV

      - name: Patch for LLVM 12 (guard NoProfile enum)
        working-directory: ${{ env.AMICE_DIR }}
        run: |
          set -eux
          f="amice-llvm/cpp/ffi.cc"
          tmp="${f}.tmp"
          awk '
            /ENUM_CASE\(llvm::Attribute::NoProfile, NoProfile\)/ {
              print "#if defined(LLVM_VERSION_MAJOR) && LLVM_VERSION_MAJOR >= 14";
              print $0;
              print "#endif";
              next
            }
            { print }
          ' "$f" > "$tmp"
          mv "$tmp" "$f"
          grep -n "NoProfile" "$f" || true

      - name: Build libamice.so (feature LLVM 12.0)
        working-directory: ${{ env.AMICE_DIR }}
        run: |
          set -eux
          cargo build --release --no-default-features --features llvm12-0
          mkdir -p "$OUT_DIR"
          cp -v target/release/libamice.so "$OUT_DIR/"

      - name: Smoke test:load plugin with this clang
        run: |
          set -eux
          echo 'int main(){return 0;}' > /tmp/t.c
          "$CLANG_DIR/bin/clang" -fpass-plugin="$OUT_DIR/libamice.so" -O2 -xc /tmp/t.c -o /tmp/t

      - name: Upload artifact (libamice.so for clang-r416183b1)
        uses: actions/upload-artifact@v4
        with:
          name: libamice-ndk-r23-clang-r416183b1
          path: ${{ env.OUT_DIR }}/libamice.so
          if-no-files-found: error
